name:  Deploy Frontend to AWS S3 & CloudFront

on:
  push:
    branches:
      - master # Usaremos 'master' como en tu script original
  workflow_dispatch: # Permite ejecuci贸n manual

# 1. DEFINICIN DE VARIABLES DE ENTORNO DE AWS
env:
  # 锔 Directorio de tu Frontend (Basado en tu script original)
  FRONTEND_DIR: ./mi-api-pwa/mi-api-pwa 
  
  # 锔 Directorio de salida despu茅s de 'npm run build' (Ajustar si es diferente de 'dist')
  BUILD_DIR_NAME: dist 
  
  # Variables de AWS tomadas de los Secrets de GitHub (ya configurados)
  S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.AWS_CLOUDFRONT_ID }}
  AWS_REGION: us-east-2 # Aseg煤rate de que esta regi贸n coincida con tu S3/CloudFront

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # Permisos de seguridad necesarios para acceder a los secrets
    permissions:
      id-token: write
      contents: read

    steps:
      - name: 猬锔 Checkout code
        uses: actions/checkout@v4

      - name:  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          cache: 'npm'
          # La ruta de cache debe ser la misma que la del working-directory
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      # П PASO CRTICO: INSTALAR DEPENDENCIAS Y CONSTRUIR (INYECCIN DE URL DEL BACKEND)
      - name: 锔 Install Dependencies and Build
        run: |
          npm ci
          npm run build
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          # Sustituimos VITE_CLOUD_RUN_URL por la URL de Elastic Beanstalk (AWS)
          VITE_API_URL: ${{ secrets.VITE_AWS_BACKEND_URL }}
          
      #  CONFIGURAR CREDENCIALES DE AWS
      # Usa los Secrets (ID y Key) para autenticarse con AWS
      - name:  Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 猬锔 DESPLIEGUE A S3 (Reemplaza la acci贸n de Firebase)
      - name: 猬锔 Deploy static files to S3
        run: aws s3 sync ${{ env.FRONTEND_DIR }}/${{ env.BUILD_DIR_NAME }} s3://${{ env.S3_BUCKET_NAME }} --delete

      # ★ INVALIDAR CLOUDFRONT (Reemplaza la acci贸n de Firebase)
      - name: ★ Invalidate CloudFront Cache
        run: aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
